
name: Deploy HTML to Apache on EC2 (port 9000)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    # If you added a label to your EC2 runner (e.g., 'ec2'), use: runs-on: [self-hosted, ec2]
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Apache is installed and running
        run: |
          set -e

          # Detect and install Apache (Ubuntu/Debian)
          if ! command -v apache2 >/dev/null 2>&1; then
            echo "Apache not found. Installing..."
            sudo apt-get update -y
            sudo apt-get install -y apache2
            sudo systemctl enable apache2
          else
            echo "Apache is already installed."
          fi

          # Ensure Apache service is running
          sudo systemctl start apache2 || true
          sudo systemctl status apache2 --no-pager || true

      - name: Configure Apache to listen on port 9000
        run: |
          set -e

          # Ensure ports.conf has Listen 9000 (idempotent)
          if ! sudo grep -qE '^\s*Listen\s+9000\b' /etc/apache2/ports.conf; then
            echo "Adding 'Listen 9000' to /etc/apache2/ports.conf"
            echo "Listen 9000" | sudo tee -a /etc/apache2/ports.conf >/dev/null
          else
            echo "'Listen 9000' already present in ports.conf"
          fi

          # Create/Update a simple VirtualHost for port 9000 (idempotent)
          VHOST_FILE="/etc/apache2/sites-available/html-9000.conf"
          sudo bash -c "cat > ${VHOST_FILE}" <<'EOF'
          <VirtualHost *:9000>
              ServerName localhost
              DocumentRoot /var/www/html

              <Directory /var/www/html>
                  Options Indexes FollowSymLinks
                  AllowOverride None
                  Require all granted
              </Directory>

              ErrorLog ${APACHE_LOG_DIR}/html-9000-error.log
              CustomLog ${APACHE_LOG_DIR}/html-9000-access.log combined
          </VirtualHost>
          EOF

          # Enable site (safe if already enabled)
          sudo a2ensite html-9000.conf || true

          # Test apache config syntax before reload
          sudo apache2ctl -t

          # Reload to apply changes
          sudo systemctl reload apache2

      - name: Deploy site content to /var/www/html
        run: |
          set -e
          sudo mkdir -p /var/www/html

          # Copy only index.html (adjust if you add more assets like CSS/JS/images)
          if [ -f ./index.html ]; then
            sudo cp ./index.html /var/www/html/index.html
          else
            echo "index.html not found in repo root" >&2
            exit 1
          fi

          # Ownership & perms (typical for static files)
          sudo chown -R www-data:www-data /var/www/html
          sudo find /var/www/html -type d -exec chmod 755 {} \;
          sudo find /var/www/html -type f -exec chmod 644 {} \;

          # Validate Apache config again and restart
          sudo apache2ctl -t
          sudo systemctl restart apache2

      - name: Validate deployment
        run: |
          set -e
          if [ ! -f /var/www/html/index.html ]; then
            echo "Deployment failed: /var/www/html/index.html missing" >&2
            exit 1
          fi
